<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Jenkins | Drink Beer, Do Something]]></title>
  <link href="http://narutaro.github.io/blog/categories/jenkins/atom.xml" rel="self"/>
  <link href="http://narutaro.github.io/"/>
  <updated>2014-05-31T12:38:10-07:00</updated>
  <id>http://narutaro.github.io/</id>
  <author>
    <name><![CDATA[narutaro]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Jenkinsのスレーブ機能が便利すぎる]]></title>
    <link href="http://narutaro.github.io/blog/2014/05/31/jekins-slave-setting/"/>
    <updated>2014-05-31T11:04:59-07:00</updated>
    <id>http://narutaro.github.io/blog/2014/05/31/jekins-slave-setting</id>
    <content type="html"><![CDATA[<p>Jenkinsのスレーブ機能がかなり便利だったので皆さんにお知らせ．</p>

<h1 id="section">今回スレーブが必要となった背景</h1>
<p>大抵のJenkinsスレーブの使い方は，ジョブ数が多くなってきたので負荷分散というケースが多いと思います．同じ設定になったJenkinsサーバが複数あって，同じジョブを分散するイメージ．このケースは結構Webにも情報がありました．</p>

<p>でも，今回のはむしろ，二つあるJenkinsサーバを楽に統合したいというものでした．すでにCIが動いている，自分のプロジェクトのServer-A Jenkinsと他のプロジェクトのServer-B Jenkinsを統合して集中管理っていう感じ．自分のServer-Aにはjenkinsだけじゃなくて，Javaやらビルドツールやらテストやらいろいろ入っているとして，AをBへくっつけるとするとやり方は</p>

<ul>
  <li>Server-B Jenkinsから個々のジョブをsshでログインしてServer-A上で実行</li>
  <li>Server-AをServer-B Jenkinsのスレーブとして設定して，マスタであるServer-Bからジョブをリモート実行</li>
</ul>

<p>両方やってみましたが，後者の方が圧倒的に楽でした．理由は複数あるジョブの設定を変えずにServer-A JenkinsからB Jenkinsにコピペするだけでいいから．おすすめ．</p>

<h1 id="section-1">マスタスレーブ構成の仕組み</h1>
<p>スレーブになるマシン(今回はServer-A)の条件は，Javaが入っていることだけ．マスタ側(Server-B Jenkins)でServer-Aをスレーブとして登録するとマスタからスレーブにJavaのエージェントプログラム(jar)が送り込まれます．これによりスレーブ上でマスタ側にあるジョブが実行できる仕組みです．送り込みはssh(scp?)でやっているようです．またマスタ側でどのジョブをどのスレーブで実行するかを設定できますので，単なる不可分散ではなく，ジョブ毎に実行するスレーブを指定する，ルーティングのようなことができます．</p>

<h1 id="section-2">スレーブノードの設定</h1>
<p>GUI上で，<code>Manage Jenkins</code> &gt; <code>Manage Nodes</code> &gt; <code>New Node</code>とたどって，<code>Dumb Slave</code>を選択．上記の仕組みなので，設定は以下だけ．</p>

<ul>
  <li>スレーブノードのIPの設定</li>
  <li>スレーブをどういう風に使うか（全ジョブか特定のジョブだけか，等）</li>
  <li>SSHの鍵設定</li>
</ul>

<p><img src="/images/article/jenkins_slave_setting/SlaveNodeSetting.png"></p>

<ul>
  <li><code>Host</code>にスレーブのIPアドレス</li>
  <li><code>Usage</code>を<code>Leave this node for tied jobs only</code>にします．後でジョブを設定するときにこのスレーブノードを選択したジョブのみこのスレーブで実行されます．</li>
  <li><code>Credentials</code>のところで，<code>Add</code>すると以下のSSHの認証設定画面がポップアップ.ここで<code>Kind</code>のところを<code>SSH Username with private key</code>として，<code>Username</code>にスレーブ側に接続するときのユーザ名をいれて，<code>Private Key</code>にSSHの秘密鍵をコピペ</li>
</ul>

<p><img src="/images/article/jenkins_slave_setting/SSHKeySetting.png"></p>

<h1 id="section-3">ジョブ側の設定</h1>
<p>GUIでスレーブ上で実行したいジョブの設定画面にいって，<code>Restrict where this project can be run</code>にチェックを入れて，さっき作ったスレーブの名前を指定．こんだけです．</p>

<p>マスタとスレーブの環境が違うと，マスタ側にはないパスとかツールを指定したりすることもあったりして，いろいろエラーがでることもあると思いますが，あくまでスレーブの設定をしているので，気にしなくていいです．</p>

<p><img src="/images/article/jenkins_slave_setting/JobSetting.png"></p>

<p>あとはマスタ側でジョブを実行すると，スレーブで実行されて，ビルド結果はマスタ上で見れるはずです．すごい．
Jenkinsは驚くほど簡単にマイグレーション，スケールアウトができることが分かりました．これは使わないと．</p>
]]></content>
  </entry>
  
</feed>
